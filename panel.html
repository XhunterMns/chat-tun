<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background:#f4f6fb }
        h1 { margin-top: 0 }
        .grid { display:flex; gap:16px }
        .card { background:white; padding:12px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); flex:1 }
        #logs { height:400px; overflow:auto; font-family:monospace; white-space:pre-wrap; }
        .user { padding:8px; border-bottom:1px solid #eee }
        .user strong { color:#0b63d6 }
    </style>
</head>
<body>
    <h1>Chat - Admin Panel</h1>
    <div class="grid">
                <div style="display:flex;flex-direction:column;gap:12px;flex:0.6">
                    <div class="card">
                        <h3>Active Users (<span id="count">0</span>)</h3>
                        <div id="users"></div>
                    </div>
                    <div class="card">
                        <h3>Statistics</h3>
                        <div>Total visits: <strong id="totalVisits">0</strong></div>
                        <div>Unique visitors: <strong id="uniqueTotal">0</strong></div>
                        <div id="visits-chart" style="height:220px;margin-top:8px"></div>
                    </div>
                </div>
                <div class="card" style="flex:1.4">
                        <h3>Activity Log</h3>
                        <div id="logs"></div>
                </div>
    </div>

    <script>
        // ApexCharts CDN
        (function loadApex(){
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/apexcharts';
            s.defer = true;
            document.head.appendChild(s);
        })();
        const wsProto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
        const url = wsProto + location.host + '/admin-ws';
        const ws = new WebSocket(url);

        const usersEl = document.getElementById('users');
        const logsEl = document.getElementById('logs');
        const countEl = document.getElementById('count');

        function kick(id) {
            if (!confirm('Kick user ' + id + '?')) return;
            ws.send(JSON.stringify({ type: 'kick', socketId: id }));
        }

        function renderUsers(list) {
            usersEl.innerHTML = (list||[]).map(u => `
                <div class="user">
                    <strong>${u.username || 'Anonymous'}</strong>
                    <button style="float:right" onclick="kick('${u.socketId}')">Kick</button><br>
                    <small>ID: ${u.socketId}</small><br>
                    <small>IP: ${u.ip || 'unknown'}</small><br>
                    <small>Connected: ${u.connectedAt}</small>
                </div>
            `).join('');
            countEl.textContent = (list||[]).length;
        }

        // Stats chart
        let visitsChart = null;
        function renderStats(data) {
            try {
                document.getElementById('totalVisits').textContent = data.totalVisits || 0;
                document.getElementById('uniqueTotal').textContent = data.uniqueTotal || 0;

                const options = {
                    chart: { type: 'area', height: 220, toolbar: { show: false } },
                    series: [{ name: 'Visits', data: data.counts || [] }],
                    xaxis: { categories: data.days || [] },
                    stroke: { curve: 'smooth' },
                    tooltip: { x: { format: 'yyyy-MM-dd' } }
                };

                if (!window.ApexCharts) {
                    // ApexCharts not loaded yet; retry shortly
                    return setTimeout(() => renderStats(data), 200);
                }

                if (!visitsChart) {
                    visitsChart = new ApexCharts(document.querySelector('#visits-chart'), options);
                    visitsChart.render();
                } else {
                    visitsChart.updateOptions(options);
                    visitsChart.updateSeries([{ data: data.counts || [] }]);
                }
            } catch (e) { console.warn('renderStats failed', e); }
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                if (!res.ok) return;
                const data = await res.json();
                renderStats(data);
            } catch (e) { console.warn('loadStats failed', e); }
        }

        function addLog(line) {
            const time = new Date().toLocaleTimeString();
            logsEl.innerText += `[${time}] ${line}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        ws.onopen = () => addLog('Admin WS connected');
        ws.onclose = () => addLog('Admin WS disconnected');
        ws.onerror = (e) => addLog('Admin WS error');

        ws.onmessage = (ev) => {
            try {
                const data = JSON.parse(ev.data);
                if (data.type === 'init') {
                    renderUsers(data.users || []);
                    (data.logs || []).forEach(l => addLog(JSON.stringify(l)));
                    // load stats on init
                    loadStats();
                } else if (data.type === 'update') {
                    if (data.users) renderUsers(data.users);
                    if (data.newLogs) data.newLogs.forEach(l => addLog(JSON.stringify(l)));
                    // refresh stats after updates
                    loadStats();
                } else if (data.type === 'log') {
                    addLog(JSON.stringify(data.payload));
                    // optionally refresh stats if a visit was logged
                    if (data.payload && data.payload.event === 'visit') loadStats();
                }
            } catch (err) {
                addLog('Invalid admin message');
            }
        };
    </script>
</body>


</html>

